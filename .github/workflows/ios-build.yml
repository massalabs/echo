name: iOS Build and Sign

on:
  push:
    # branches: [dev, main]
    # paths:
    #   - 'src/**'
    #   - 'ios/**'
    #   - 'capacitor.config.ts'
    #   - 'package.json'
  pull_request:
  workflow_dispatch:
    inputs:
      upload_to_testflight:
        description: 'Upload to TestFlight'
        required: false
        default: false
        type: boolean

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build web app
        env:
          VITE_PROTOCOL_API_URL: https://api.usegossip.com/
        run: npm run build

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install CocoaPods dependencies
        working-directory: ios/App
        run: |
          # gem update
          # gem install cocoapods
          pod install

      - name: Sync Capacitor
        run: npm run cap:sync:ios

      # Install Certificate for Manual Code Signing
      - name: Install Certificate
        env:
          APPLE_APP_CERTIFICATE_P12_BASE64: ${{ secrets.APPLE_APP_CERTIFICATE_P12_BASE64 }}
          APPLE_APP_CERTIFICATE_P12_PASSWORD: ${{ secrets.APPLE_APP_CERTIFICATE_P12_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain
          KEYCHAIN_PASSWORD=temp_password

          # Decode certificate
          echo "$APPLE_APP_CERTIFICATE_P12_BASE64" | base64 --decode > $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          security import $CERTIFICATE_PATH -k $KEYCHAIN_PATH -P "$APPLE_APP_CERTIFICATE_P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security

          # Set keychain to default and allow codesign to access it
          security list-keychains -s $KEYCHAIN_PATH
          security default-keychain -s $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Verify certificate is installed
          security find-identity -v -p codesigning $KEYCHAIN_PATH

      # Install Provisioning Profile (if you have one)
      # - name: Install Provisioning Profile
      #   env:
      #     APPLE_APP_PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_APP_PROVISIONING_PROFILE_BASE64 }}
      #   run: |
      #     mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

      #     # Check if secret is available
      #     if [ -z "$APPLE_APP_PROVISIONING_PROFILE_BASE64" ]; then
      #       echo "WARNING: APPLE_APP_PROVISIONING_PROFILE_BASE64 secret is empty or missing."
      #       echo "Build may fail if a provisioning profile is required."
      #     else
      #       echo "$APPLE_APP_PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
      #       PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< $(security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision))
      #       mv ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$PROFILE_UUID.mobileprovision
      #       echo "Installed Provisioning Profile: $PROFILE_UUID"
      #       echo "PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV
      #     fi

      # # Build and Archive with Manual Code Signing
      # - name: Build and Archive iOS App
      #   env:
      #     APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      #     KEYCHAIN_PATH: ${{ runner.temp }}/build.keychain
      #   working-directory: ios/App
      #   run: |
      #     # List available schemes
      #     echo "Available schemes:"
      #     xcodebuild -workspace App.xcworkspace -list

      #     # List available SDKs
      #     echo "Available SDKs:"
      #     xcodebuild -showsdks | grep iphoneos || true

      #     # Find available iOS SDK version
      #     IOS_SDK=$(xcodebuild -showsdks | grep iphoneos | head -1 | awk '{print $NF}' || echo "iphoneos")
      #     echo "Using SDK: $IOS_SDK"

      #     # Show available destinations
      #     echo "Available destinations:"
      #     xcodebuild -workspace App.xcworkspace -scheme Gossip -showdestinations || true

      #     # Find the certificate identity
      #     CERT_IDENTITY=$(security find-identity -v -p codesigning $KEYCHAIN_PATH | grep "Apple Distribution" | head -1 | grep -o '"[^"]*"' | tr -d '"')

      #     if [ -z "$CERT_IDENTITY" ]; then
      #       echo "Error: No Apple Distribution certificate found"
      #       security find-identity -v -p codesigning $KEYCHAIN_PATH
      #       exit 1
      #     fi

      #     echo "Using certificate: $CERT_IDENTITY"

      #     # Determine Provisioning Profile Specifier
      #     if [ -n "$PROFILE_UUID" ]; then
      #       PROVISIONING_PROFILE_ARG="PROVISIONING_PROFILE_SPECIFIER=$PROFILE_UUID"
      #       echo "Using Provisioning Profile: $PROFILE_UUID"
      #     else
      #        # Try to build without explicit profile if none installed (likely to fail for manual signing)
      #       PROVISIONING_PROFILE_ARG=""
      #       echo "No Provisioning Profile UUID found. Attempting build without explicit profile..."
      #     fi

      #     # Build and archive with explicit generic iOS device destination
      #     # Use generic iphoneos SDK and override deployment target
      #     xcodebuild clean archive \
      #       -workspace App.xcworkspace \
      #       -scheme Gossip \
      #       -configuration Release \
      #       -destination "generic/platform=iOS" \
      #       -archivePath build/Gossip.xcarchive \
      #       CODE_SIGN_IDENTITY="$CERT_IDENTITY" \
      #       CODE_SIGN_STYLE="Manual" \
      #       DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
      #       $PROVISIONING_PROFILE_ARG \
      #       IPHONEOS_DEPLOYMENT_TARGET=17.0 \
      #       -sdk iphoneos \
      #       -allowProvisioningUpdates

      # Export IPA for TestFlight/App Store
      # - name: Export IPA
      #   if: github.event.inputs.upload_to_testflight == 'true' || github.ref == 'refs/heads/main'
      #   env:
      #     APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      #     KEYCHAIN_PATH: ${{ runner.temp }}/build.keychain
      #   working-directory: ios/App
      #   run: |
      #     # Find the certificate identity
      #     CERT_IDENTITY=$(security find-identity -v -p codesigning $KEYCHAIN_PATH | grep "Apple Distribution" | head -1 | grep -o '"[^"]*"' | tr -d '"')

      #     # Create exportOptions.plist with manual signing
      #     cat > exportOptions.plist << EOF
      #     <?xml version="1.0" encoding="UTF-8"?>
      #     <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      #     <plist version="1.0">
      #     <dict>
      #       <key>method</key>
      #       <string>app-store</string>
      #       <key>teamID</key>
      #       <string>$APPLE_TEAM_ID</string>
      #       <key>uploadBitcode</key>
      #       <false/>
      #       <key>uploadSymbols</key>
      #       <true/>
      #       <key>compileBitcode</key>
      #       <false/>
      #       <key>signingStyle</key>
      #       <string>manual</string>
      #       <key>signingCertificate</key>
      #       <string>$CERT_IDENTITY</string>
      #     </dict>
      #     </plist>
      #     EOF

      #     xcodebuild -exportArchive \
      #       -archivePath build/Gossip.xcarchive \
      #       -exportPath build \
      #       -exportOptionsPlist exportOptions.plist

      # Upload to TestFlight using altool (deprecated but still works)
      # Note: Consider using App Store Connect API or Fastlane for better reliability
      # - name: Upload to TestFlight
      #   if: github.event.inputs.upload_to_testflight == 'true'
      #   env:
      #     APPLE_ID: ${{ secrets.APPLE_ID }}
      #     APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
      #   working-directory: ios/App
      #   run: |
      #     xcrun altool --upload-app \
      #       --type ios \
      #       --file "build/App.ipa" \
      #       --username "$APPLE_ID" \
      #       --password "$APPLE_APP_PASSWORD"

      # - name: Upload IPA artifact
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: ios-app
      #     path: ios/App/build/*.ipa
      #     retention-days: 7
