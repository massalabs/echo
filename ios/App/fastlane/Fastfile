# Fastfile for Gossip iOS App

default_platform(:ios)

platform :ios do
  # Private lane containing common build logic
  private_lane :build_app_common do
    # Setup CI environment (creates temporary keychain)
    setup_ci if ENV['CI']
    
    # Use match for code signing
    # In CI, create certificates if they don't exist
    match(
      type: "development",
      readonly: ENV['CI'] ? false : true,  # Create certificates in CI if needed
      app_identifier: "net.massa.gossip",
      skip_certificate_verification: ENV['CI'] ? true : false  # Skip verification in CI for speed
    )

    # Build the app
    build_app(
      workspace: "App.xcworkspace",
      scheme: "Gossip",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./",
      output_name: "Gossip.ipa",
      clean: false,
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "net.massa.gossip" => "match AppStore net.massa.gossip"
        },
        signingStyle: "manual",
        teamID: ENV["APPLE_TEAM_ID"]
      }
    )

    UI.success("‚úÖ Build completed successfully!")
  end

  desc "Build the iOS app"
  lane :build do
    build_app_common
  end

  desc "Build and upload to TestFlight"
  lane :beta do
    # Build the app using common logic
    build_app_common

    # Upload to TestFlight
    upload_to_testflight(
      apple_id: ENV["APPLE_ID"],
      skip_waiting_for_build_processing: ENV["FASTLANE_SKIP_WAITING_FOR_BUILD_PROCESSING"] == "true",
      skip_submission: true,
      distribute_external: false,
      notify_external_testers: false,
      ipa: "./Gossip.ipa"
    )

    UI.success("üöÄ Successfully uploaded to TestFlight!")
  end

  desc "Download certificates and provisioning profiles using match"
  lane :setup_signing do
    UI.message("Setting up code signing with match...")
    
    match(
      type: "development",
      app_identifier: "net.massa.gossip",
      skip_certificate_verification: ENV['CI'] ? true : false
    )
    
    UI.success("‚úÖ Code signing setup completed!")
  end
  
  desc "Create new certificates and provisioning profiles"
  lane :match_init do
    UI.message("Creating certificates with match...")
    
    match(
      type: "development",
      app_identifier: "net.massa.gossip",
      skip_certificate_verification: false  # Always verify when creating new certs
    )
    
    UI.success("‚úÖ Certificates created and stored in git!")
  end

  # Error handling
  error do |lane, exception|
    UI.error("‚ùå Error in lane '#{lane}': #{exception.message}")
  end
end

